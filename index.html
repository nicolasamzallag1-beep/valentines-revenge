<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <title>Valentine's Revenge ‚Äî Salle de Bain Girly üå°Ô∏è</title>

 <link rel="preconnect" href="https://fonts.googleapis.com" />
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
 <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700;800&display=swap" rel="stylesheet" />

 <style>
 :root{
   --bg1:#ffe6f0;
   --bg2:#ffb6d5;
   --neon:#ff69b4;
   --neon2:#ff85c1;
   --gold:#fbbf24;
   --good:#34d399;
   --bad:#fb7185;
   --glass: rgba(255,255,255,.15);
   --glass2: rgba(255,255,255,.25);
   --stroke: rgba(255,255,255,.3);
   --shadow: rgba(0,0,0,.15);
 }

 *{ box-sizing:border-box; }
 html, body{ height:100%; }
 body{
   margin:0;
   font-family: "Oxanium", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
   background: radial-gradient(1200px 900px at 30% 20%, rgba(255,105,180,.28), transparent 55%),
               radial-gradient(1000px 800px at 80% 60%, rgba(255,182,193,.22), transparent 50%),
               linear-gradient(180deg, var(--bg1), var(--bg2));
   color:#4b004b;
   overflow:hidden;
   user-select:none;
   cursor: crosshair;
 }

 /* subtle animated grain */
 body::before{
   content:"";
   position:fixed;
   inset:0;
   background:
     radial-gradient(circle at 20% 10%, rgba(255,182,193,.06), transparent 30%),
     radial-gradient(circle at 70% 40%, rgba(255,105,180,.05), transparent 28%),
     radial-gradient(circle at 40% 80%, rgba(255,192,203,.04), transparent 25%);
   mix-blend-mode: overlay;
   pointer-events:none;
   opacity:.55;
   animation: drift 8s ease-in-out infinite;
 }
 @keyframes drift{
   0%,100%{ transform: translate3d(0,0,0) scale(1); }
   50%{ transform: translate3d(-12px,10px,0) scale(1.02); }
 }

 #game{
   position:relative;
   width:100vw;
   height:100vh;
   overflow:hidden;
 }

 canvas{
   position:absolute;
   inset:0;
   width:100%;
   height:100%;
   display:none;
 }

 /* HUD */
 #hud{
   position:absolute;
   inset:18px 18px auto 18px;
   display:none;
   gap:12px;
   align-items:flex-start;
   z-index:30;
   pointer-events:none;
 }

 .hudCard{
   pointer-events:auto;
   background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.15));
   border: 1px solid var(--stroke);
   border-radius: 16px;
   padding: 10px 14px;
   min-width: 140px;
   box-shadow: 0 18px 40px var(--shadow);
   backdrop-filter: blur(14px);
 }

 .hudLabel{
   font-size: 11px;
   letter-spacing: .14em;
   text-transform: uppercase;
   color: rgba(75,0,75,.75);
   margin-bottom:4px;
 }

 .hudValue{
   font-size: 26px;
   font-weight: 800;
   line-height:1.05;
   text-shadow: 0 0 18px rgba(255,105,180,.5);
 }

 #hudScore .hudValue{ color: var(--neon); }
 #hudTime .hudValue{ color: var(--good); }
 #hudHits .hudValue{ color: var(--neon2); }

 #topRight{
   position:absolute;
   top:18px;
   right:18px;
   z-index:31;
   display:none;
   gap:10px;
   align-items:center;
 }

 .btn{
   font-family: "Oxanium", sans-serif;
   font-weight: 800;
   letter-spacing:.08em;
   text-transform: uppercase;
   border: 1px solid var(--stroke);
   background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.15));
   color: #4b004b;
   padding: 10px 14px;
   border-radius: 14px;
   cursor:pointer;
   transition: transform .15s ease, background .15s ease, border-color .15s ease;
   box-shadow: 0 14px 34px var(--shadow);
   backdrop-filter: blur(14px);
 }
 .btn:hover{ transform: translateY(-2px); border-color: rgba(255,105,180,.5); }
 .btn:active{ transform: translateY(0); }

 /* Start overlay */
 #start{
   position:absolute;
   inset:0;
   display:flex;
   flex-direction:column;
   align-items:center;
   justify-content:center;
   gap:16px;
   z-index:50;
   background:
     radial-gradient(900px 650px at 50% 35%, rgba(255,105,180,.35), transparent 55%),
     radial-gradient(800px 600px at 65% 65%, rgba(255,182,193,.22), transparent 55%),
     linear-gradient(180deg, rgba(255,192,203,.65), rgba(255,182,193,.88));
   backdrop-filter: blur(14px);
 }

 .title{
   font-size: clamp(34px, 6vw, 70px);
   font-weight: 800;
   letter-spacing: .06em;
   line-height:1;
   margin:0;
   text-align:center;
   text-shadow:
     0 0 28px rgba(255,105,180,.35),
     0 0 24px rgba(255,182,193,.22),
     0 16px 60px rgba(255,192,203,.55);
 }

 .badge{
   display:inline-flex;
   align-items:center;
   gap:10px;
   padding: 10px 14px;
   border-radius: 999px;
   border:1px solid var(--stroke);
   background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.15));
   backdrop-filter: blur(14px);
   box-shadow: 0 18px 42px var(--shadow);
   color: rgba(75,0,75,.9);
   font-weight:700;
   letter-spacing:.08em;
   text-transform: uppercase;
   font-size: 12px;
 }

 .panel{
   width:min(860px, calc(100vw - 32px));
   border-radius: 22px;
   border: 1px solid rgba(255,255,255,.3);
   background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.15));
   box-shadow: 0 28px 70px rgba(0,0,0,.15);
   backdrop-filter: blur(16px);
   padding: 18px;
 }

 .grid{
   display:grid;
   grid-template-columns: repeat(4, 1fr);
   gap: 12px;
 }

 .diff{
   border:none;
   cursor:pointer;
   border-radius: 18px;
   padding: 14px 14px;
   color:#4b004b;
   text-align:left;
   background: linear-gradient(135deg, rgba(255,255,255,.25), rgba(255,255,255,.15));
   border: 1px solid rgba(255,255,255,.3);
   transition: transform .15s ease, border-color .15s ease, box-shadow .15s ease;
   box-shadow: 0 18px 46px rgba(0,0,0,.15);
   position:relative;
   overflow:hidden;
   font-family: "Oxanium", sans-serif;
 }

 .diff::before{
   content:"";
   position:absolute;
   inset:-2px;
   background: radial-gradient(500px 220px at 30% 20%, rgba(255,182,193,.28), transparent 55%),
               radial-gradient(420px 220px at 90% 80%, rgba(255,105,180,.32), transparent 55%);
   opacity:.8;
   pointer-events:none;
 }

 .diff:hover{
   transform: translateY(-3px);
   border-color: rgba(255,105,180,.5);
   box-shadow: 0 26px 64px rgba(0,0,0,.15);
 }

 .diffName{ position:relative; z-index:1; font-weight:800; letter-spacing:.1em; text-transform:uppercase; }
 .diffDesc{ position:relative; z-index:1; margin-top:6px; color: rgba(75,0,75,.78); font-weight:600; font-size:13px; line-height:1.3; }

 .hint{
   margin-top: 12px;
   color: rgba(75,0,75,.75);
   font-weight:600;
   line-height:1.55;
   text-align:center;
   font-size: 14px;
 }

 .kbd{
   display:inline-flex;
   align-items:center;
   justify-content:center;
   padding: 2px 8px;
   border-radius: 8px;
   border:1px solid rgba(75,0,75,.18);
   background: rgba(255,192,203,.25);
   font-weight:800;
   letter-spacing:.06em;
   font-size: 12px;
   margin: 0 3px;
 }

 /* End overlay */
 #end{
   position:absolute;
   inset:0;
   display:none;
   flex-direction:column;
   align-items:center;
   justify-content:center;
   gap:16px;
   z-index:60;
   background: linear-gradient(180deg, rgba(255,192,203,.78), rgba(255,182,193,.92));
   backdrop-filter: blur(16px);
 }

 .endTitle{ font-size: clamp(28px, 5vw, 54px); font-weight: 900; letter-spacing:.06em; margin:0; color: #4b004b; }
 .endScore{ font-size: clamp(20px, 4vw, 34px); font-weight: 800; color: var(--neon); }
 .endMsg{ max-width: 860px; padding: 0 18px; text-align:center; color: rgba(75,0,75,.88); font-weight: 600; line-height:1.75; }

 /* Floating hit bubble (anchored near target, clamped inside viewport) */
 .hitBubble{
   position:absolute;
   z-index:80;
   max-width: min(360px, calc(100vw - 16px));
   padding: 10px 12px;
   border-radius: 16px;
   background: rgba(255,255,255,.92);
   color: #4b004b;
   font-weight: 800;
   box-shadow: 0 18px 50px rgba(0,0,0,.15);
   border: 1px solid rgba(0,0,0,.08);
   pointer-events:none;
   transform-origin: left center;
   animation: pop .18s ease-out;
 }

 .hitBubble small{
   display:block;
   margin-top:4px;
   font-weight:700;
   opacity:.75;
   letter-spacing:.04em;
 }

 @keyframes pop{
   from{ transform: translate3d(0,6px,0) scale(.92); opacity:0; }
   to{ transform: translate3d(0,0,0) scale(1); opacity:1; }
 }

 /* little arrow */
 .hitBubble::after{
   content:"";
   position:absolute;
   width: 10px;
   height: 10px;
   background: rgba(255,255,255,.92);
   left: -5px;
   top: 16px;
   transform: rotate(45deg);
   border-left: 1px solid rgba(0,0,0,.08);
   border-bottom: 1px solid rgba(0,0,0,.08);
 }

 /* tweak arrow when bubble is on the left */
 .hitBubble.leftSide::after{
   left: auto;
   right: -5px;
   transform: rotate(225deg);
   border-left: none;
   border-bottom: none;
   border-right: 1px solid rgba(0,0,0,.08);
   border-top: 1px solid rgba(0,0,0,.08);
 }

 /* Combo banner */
 #combo{
   position:absolute;
   left:50%;
   top:50%;
   transform: translate(-50%,-50%);
   font-size: clamp(34px, 6vw, 72px);
   font-weight: 900;
   letter-spacing:.06em;
   color: var(--neon);
   text-shadow:
     0 0 26px rgba(255,105,180,.35),
     0 0 32px rgba(255,182,193,.32),
     0 20px 70px rgba(0,0,0,.7);
   opacity:0;
   pointer-events:none;
   z-index:40;
 }
 #combo.show{ animation: combo .9s ease-out forwards; }
 @keyframes combo{
   0%{ opacity:0; transform: translate(-50%,-50%) scale(.75) rotate(-6deg); }
   20%{ opacity:1; transform: translate(-50%,-50%) scale(1.1) rotate(2deg); }
   70%{ opacity:1; transform: translate(-50%,-50%) scale(1.02) rotate(-1deg); }
   100%{ opacity:0; transform: translate(-50%,-50%) scale(.9) rotate(0deg); }
 }

 /* Floating thermometer animation */
 .floaters{
   position:absolute;
   inset:0;
   pointer-events:none;
   z-index:55;
   overflow:hidden;
 }
 .floater{
   position:absolute;
   font-size: 34px;
   opacity:.28;
   filter: drop-shadow(0 12px 24px rgba(0,0,0,.15));
   animation: floatUp var(--dur, 10s) linear infinite;
 }
 @keyframes floatUp{
   0%{ transform: translate3d(0, 110vh, 0) rotate(0deg) scale(var(--s,1)); opacity:0; }
   10%{ opacity: var(--o,.28); }
   90%{ opacity: var(--o,.28); }
   100%{ transform: translate3d(0, -140px, 0) rotate(360deg) scale(var(--s,1)); opacity:0; }
 }

 /* Mobile adjustments */
 @media (max-width: 900px){
   .grid{ grid-template-columns: repeat(2, 1fr); }
   #hud{ inset: 14px 14px auto 14px; }
   #topRight{ top:14px; right:14px; }
   .hudCard{ min-width: 120px; }
 }

 /* Animation doigt d'honneur (grosse et anim√©e) */
 .middleFinger{
   position:absolute;
   font-size: 72px;
   z-index:90;
   pointer-events:none;
   animation: fingerPop 1.15s cubic-bezier(.16,1,.3,1) forwards;
   text-shadow: 0 0 20px rgba(255,105,180,.55), 0 10px 34px rgba(0,0,0,.55);
   filter: drop-shadow(0 18px 26px rgba(0,0,0,.15));
   will-change: transform, opacity;
 }
 @keyframes fingerPop{
   0%{ transform: translate(-50%,-50%) scale(0) rotate(var(--r, -16deg)); opacity:0; }
   14%{ transform: translate(-50%,-50%) scale(1.55) rotate(calc(var(--r, -16deg) * -0.35)); opacity:1; }
   34%{ transform: translate(-50%,-50%) scale(1.25) rotate(calc(var(--r, -16deg) * 0.25)); opacity:1; }
   72%{ transform: translate(-50%,-50%) scale(1.32) rotate(calc(var(--r, -16deg) * -0.15)); opacity:1; }
   100%{ transform: translate(-50%,-50%) scale(0.88) rotate(0deg); opacity:0; }
 }

 /* Micro screen shake (feel de hit) */
 #game.shake{ animation: shake .28s ease-out; }
 @keyframes shake{
   0%{ transform: translate3d(0,0,0); }
   18%{ transform: translate3d(-3px, 2px,0) rotate(-0.2deg); }
   38%{ transform: translate3d(3px, -2px,0) rotate(0.2deg); }
   60%{ transform: translate3d(-2px, -1px,0) rotate(-0.1deg); }
   100%{ transform: translate3d(0,0,0); }
 }
 </style>
</head>
<body>
 <div id="game">
 <canvas id="c"></canvas>

 <div id="hud">
 <div class="hudCard" id="hudScore"><div class="hudLabel">Score</div><div class="hudValue" id="score">0</div></div>
 <div class="hudCard" id="hudTime"><div class="hudLabel">Temps</div><div class="hudValue" id="time">30</div></div>
 <div class="hudCard" id="hudHits"><div class="hudLabel">Hits</div><div class="hudValue" id="hits">0</div></div>
 </div>

 <div id="topRight">
 <button class="btn" id="pauseBtn">‚è∏ Pause</button>
 <button class="btn" id="soundBtn" title="Activer/D√©sactiver le son">üîä Son</button>
 </div>

 <div id="combo"></div>

 <div id="start">
 <div class="floaters" aria-hidden="true">
 <span class="floater" style="left:6%; --dur:11s; --s:.9; --o:.22;">üå°Ô∏è</span>
 <span class="floater" style="left:18%; --dur:9s; --s:1.1; --o:.28; animation-delay:-2s;">üå°Ô∏è</span>
 <span class="floater" style="left:33%; --dur:12s; --s:.8; --o:.18; animation-delay:-6s;">üå°Ô∏è</span>
 <span class="floater" style="left:51%; --dur:10s; --s:1.25; --o:.26; animation-delay:-4s;">üå°Ô∏è</span>
 <span class="floater" style="left:67%; --dur:13s; --s:.95; --o:.20; animation-delay:-8s;">üå°Ô∏è</span>
 <span class="floater" style="left:82%; --dur:9.5s; --s:1.05; --o:.24; animation-delay:-5s;">üå°Ô∏è</span>
 <span class="floater" style="left:92%; --dur:12.5s; --s:.85; --o:.18; animation-delay:-9s;">üå°Ô∏è</span>
 </div>

 <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;justify-content:center;">
 <img src="./malo.jpg" alt="Malo" style="width:86px;height:86px;border-radius:50%;border:3px solid rgba(75,0,75,.30);object-fit:cover;box-shadow:0 10px 26px rgba(0,0,0,.15);transform:rotate(-2deg);">
 <img src="./marie.jpg" alt="Marie" style="width:86px;height:86px;border-radius:50%;border:3px solid rgba(75,0,75,.30);object-fit:cover;box-shadow:0 10px 26px rgba(0,0,0,.15);transform:rotate(1deg);">
 <img src="./nico.jpg" alt="Nico" style="width:86px;height:86px;border-radius:50%;border:3px solid rgba(75,0,75,.30);object-fit:cover;box-shadow:0 10px 26px rgba(0,0,0,.15);transform:rotate(-1deg);">
 <img src="./valentine.jpg" alt="Valentine" style="width:86px;height:86px;border-radius:50%;border:3px solid rgba(75,0,75,.30);object-fit:cover;box-shadow:0 10px 26px rgba(0,0,0,.15);transform:rotate(2deg);">
 </div>

 <h1 class="title">VALENTINE'S REVENGE</h1>
 <div class="badge">üõÅ Make-Up ‚Ä¢ üå°Ô∏è Thermom√®tres ‚Ä¢ üñï Vengeance</div>
 <div class="hint" style="max-width:860px;padding:0 18px;margin-top:2px;">
 Bienvenue dans la salle de bain la plus girly de l'histoire. Valentine veut sa revanche.<br/>
 Lance des thermom√®tres sur tes potes qui d√©filent. Ils vont pleurer, te balancer des doigts d'honneur ‚Äî et toi tu vas kiffer.
 </div>

 <div class="panel">
 <div id="enterSection" style="display:flex;justify-content:center;margin:16px 0 10px;">
 <button class="btn" id="enterBtn" style="font-size:18px;padding:12px 32px;">ENTER</button>
 </div>

 <div id="diffSection" style="display:none;">
 <div class="grid">
 <button class="diff" data-diff="easy"><div class="diffName">Easy</div><div class="diffDesc">Cool & smooth<br/>Pour s'√©chauffer.</div></button>
 <button class="diff" data-diff="medium"><div class="diffName">Medium</div><div class="diffDesc">√áa commence √† piquer<br/>mais c'est g√©rable.</div></button>
 <button class="diff" data-diff="hard"><div class="diffName">Hard</div><div class="diffDesc">R√©flexes obligatoires<br/>sinon c'est honteux.</div></button>
 <button class="diff" data-diff="insane"><div class="diffName">Insane</div><div class="diffDesc">Speedrun d'ap√©ro<br/>√ßa part en orbite.</div></button>
 </div>
 <div class="hint">
 Clique pour <b>lancer un thermom√®tre</b> üå°Ô∏è vers une t√™te.<br/>
 <span class="kbd">P</span> pause ‚Ä¢ <i class="fas fa-volume-up"></i> ‚Ä¢ Le son d√©marre au premier clic.
 </div>
 </div>
 </div>
 </div></div>

 <div id="end">
 <h2 class="endTitle">FIN DE PARTIE</h2>
 <div class="endScore">Score : <span id="finalScore">0</span></div>
 <div class="endMsg" id="finalMsg"></div>
 <button class="btn" id="restartBtn">‚Üª Rejouer</button>
 </div>
 </div>

 <script>
 // Le code JavaScript est identique √† l'original sauf la fonction throwWine renomm√©e en throwThermometer et modifi√©e pour afficher üå°Ô∏è

 // Configuration photos (identique)
 const friends = [
   { id: "malo", name: "Malo", img: "./malo.jpg" },
   { id: "marie", name: "Marie", img: "./marie.jpg" },
   { id: "ptitnico", name: "PtitNico", img: "./nico.jpg" },
   { id: "valentine", name: "Valentine", img: "./valentine.jpg" },
 ];

 // Pr√©chargement images (identique)
 const imageCache = new Map();
 function preloadImages(){
   for (const f of friends){
     const img = new Image();
     img.src = f.img;
     img.onload = () => imageCache.set(f.id, img);
     imageCache.set(f.id, img);
   }
 }

 // Difficult√©s (identique)
 const diff = {
   easy:  { speed: 2.1, spawnMs: 1900, duration: 30, points: 10 },
   medium: { speed: 3.0, spawnMs: 1400, duration: 30, points: 15 },
   hard:  { speed: 4.2, spawnMs: 1000, duration: 30, points: 25 },
   insane: { speed: 5.5, spawnMs: 780, duration: 30, points: 40 },
 };

 // Constantes gameplay (identique)
 const GRAVITY = 2600;
 const AIM_ASSIST_RADIUS = 120;

 // Messages (identiques)
 const hitMessagesByCharacter = {
   malo: [
     "Mais c'est qui √ßa ?",
     "Retourne bosser, y'a le bac qui arrive !",
     "Au fait, j'ai une anectdote",
     "T'es perdu ?",
     "La vie c'est dur, alors rigole un peu !",
     "C'√©tait pas ton jour.",
     "Bon, ok, chapeau bas.",
     "Allez, vive ll'OM !",
   ],
   marie: [
     "Une bouteille de rouge, √ßa te dit ?",
     "√áa suffit les conneries !",
     "Tu te tais !",
     "T'as un souci ou quoi ?",
     "Je vais vous d√©gommer",
     "Dans ton cul !",
   ],
   ptitnico: [
     "Peace !",
     "On respire un bon coup. ",
     "Pas mal, mais √ßa suffit pas.",
     "Bien tent√©.",
     "Tu t'acharnes pour rien.",
     "Mauvais karma, mon pote.",
     "Pas cool du tout √ßa.",
   ],
   valentine: [
     "T'as cru que c'√©tait malin ?",
     "Retourne sur TikTok, s√©rieux !",
     "Sorry, je parle pas fran√ßais.",
     "Je me casse, j'ai une soir√©e VIP.",
     "Je pars ! j'ai une soir√©e ce soir !",
     "D√©sol√©e, c'est non !",
     "Faut √™tre au top pour √ßa.",
   ],
 };

 const missMessages = [
   "Rat√©.",
   "Valentine est d√©√ßue",
   "Valeintine s'attendait √† mieux",
   "Nul √† chier !",
   "C'√©tait ambitieux. Trop.",
 ];

 const finalMessages = [
   { min: 0,  max: 599,  msg: "T'es vraiment nul, Valentine est √©nerv√©e." },
   { min: 600, max: 1199, msg: "Pas mal, mais Valentine s'attendait √† mieux venant de toi." },
   { min: 1200, max: 2699, msg: "Bien jou√©, Valentine commence √† pleurer." },
   { min: 2700, max: 3499, msg: "Impressionnant, Valentine est en √©poustoufl√©e." },
   { min: 3500, max: 9999, msg: "L√©gende vivante, Valeintine te respecte enfin." },
 ];

 // DOM & Canvas setup (identique)
 const gameEl = document.getElementById("game");
 const canvas = document.getElementById("c");
 const ctx = canvas.getContext("2d");

 const startEl = document.getElementById("start");
 const endEl = document.getElementById("end");
 const restartBtn = document.getElementById("restartBtn");

 const hudEl = document.getElementById("hud");
 const topRightEl = document.getElementById("topRight");
 const pauseBtn = document.getElementById("pauseBtn");
 const soundBtn = document.getElementById("soundBtn");

 const scoreEl = document.getElementById("score");
 const timeEl = document.getElementById("time");
 const hitsEl = document.getElementById("hits");
 const comboEl = document.getElementById("combo");
 const finalScoreEl = document.getElementById("finalScore");
 const finalMsgEl = document.getElementById("finalMsg");

 // Resize canvas (identique)
 function resize(){
   const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
   canvas.width = Math.floor(window.innerWidth * dpr);
   canvas.height = Math.floor(window.innerHeight * dpr);
   canvas.style.width = window.innerWidth + "px";
   canvas.style.height = window.innerHeight + "px";
   ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
 }
 window.addEventListener("resize", resize);

 // Helpers (identique)
 const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
 const rand = (a,b) => a + Math.random() * (b-a);
 const pick = arr => arr[(Math.random() * arr.length) | 0];

 function drawImageCover(ctx, img, x, y, w, h){
   const iw = img.naturalWidth || img.width;
   const ih = img.naturalHeight || img.height;
   if (!iw || !ih) return;
   const r = Math.max(w / iw, h / ih);
   const nw = iw * r;
   const nh = ih * r;
   const cx = x + (w - nw) / 2;
   const cy = y + (h - nh) / 2;
   ctx.drawImage(img, cx, cy, nw, nh);
 }

 function showCombo(n){
   comboEl.textContent = `COMBO x${n}`;
   comboEl.classList.remove("show");
   void comboEl.offsetWidth;
   comboEl.classList.add("show");
 }

 function showHitBubble(text, x, y, who){
   const el = document.createElement("div");
   el.className = "hitBubble";
   el.innerHTML = `${escapeHtml(text)}<small>${escapeHtml(who)}</small>`;
   gameEl.appendChild(el);

   el.style.left = (x + 18) + "px";
   el.style.top = (y - 18) + "px";

   const pad = 8;
   const r = el.getBoundingClientRect();
   let left = parseFloat(el.style.left);
   let top = parseFloat(el.style.top);

   if (left + r.width > window.innerWidth - pad){
     left = x - r.width - 18;
     el.style.transformOrigin = "right center";
     el.style.setProperty("--arrow", "left");
     el.style.setProperty("--flip", "1");
     el.style.setProperty("--arrowSide", "right");
     el.style.setProperty("--arrowLeft", "auto");
   }

   left = clamp(left, pad, window.innerWidth - r.width - pad);
   top = clamp(top, pad, window.innerHeight - r.height - pad);
   el.style.left = left + "px";
   el.style.top = top + "px";

   const placedLeft = (left < x);
   if (placedLeft){
     el.style.transformOrigin = "right center";
     el.style.setProperty("--arrowOnLeft", "0");
     el.style.setProperty("--arrowX", "auto");
     el.style.setProperty("--arrowR", "-5px");
     el.style.setProperty("--arrowL", "auto");
     el.style.setProperty("--arrow", "right");
     el.classList.add("leftSide");
   }

   setTimeout(() => {
     el.style.transition = "opacity .22s ease, transform .22s ease";
     el.style.opacity = "0";
     el.style.transform = "translateY(-6px) scale(.98)";
     setTimeout(() => el.remove(), 240);
   }, 1050);
 }

 function escapeHtml(str){
   return String(str)
     .replaceAll("&", "&amp;")
     .replaceAll("<", "&lt;")
     .replaceAll(">", "&gt;")
     .replaceAll('"', "&quot;")
     .replaceAll("'", "&#39;");
 }

 // Audio (identique)
 let audio = null;

 function initAudio(){
   if (audio) return audio;

   const AC = window.AudioContext || window.webkitAudioContext;
   const ctxA = new AC();

   const master = ctxA.createGain();
   master.gain.value = 0.55;

   const comp = ctxA.createDynamicsCompressor();
   comp.threshold.value = -18;
   comp.knee.value = 24;
   comp.ratio.value = 6;
   comp.attack.value = 0.003;
   comp.release.value = 0.12;

   master.connect(comp);
   comp.connect(ctxA.destination);

   const musicBus = ctxA.createGain();
   const sfxBus = ctxA.createGain();
   musicBus.gain.value = 0.9;
   sfxBus.gain.value = 1.0;

   const musicLP = ctxA.createBiquadFilter();
   musicLP.type = "lowpass";
   musicLP.frequency.value = 9500;
   musicLP.Q.value = 0.7;

   musicBus.connect(musicLP);
   musicLP.connect(master);
   sfxBus.connect(master);

   const state = {
     ctx: ctxA,
     enabled: true,
     bpm: 142,
     next: 0,
     timer: null,
     step: 0,
   };

   function now(){ return ctxA.currentTime; }

   function tone(freq, t0, dur, type, gain, out=musicBus){
     const o = ctxA.createOscillator();
     const g = ctxA.createGain();
     o.type = type;
     o.frequency.setValueAtTime(freq, t0);
     g.gain.setValueAtTime(0.0001, t0);
     g.gain.exponentialRampToValueAtTime(gain, t0 + 0.008);
     g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
     o.connect(g);
     g.connect(out);
     o.start(t0);
     o.stop(t0 + dur + 0.02);
   }

   function noise(t0, dur, gain, hp=6000, out=sfxBus){
     const len = Math.max(1, Math.floor(ctxA.sampleRate * dur));
     const buf = ctxA.createBuffer(1, len, ctxA.sampleRate);
     const d = buf.getChannelData(0);
     for (let i=0;i<len;i++) d[i] = Math.random()*2-1;
     const src = ctxA.createBufferSource();
     src.buffer = buf;

     const f = ctxA.createBiquadFilter();
     f.type = "highpass";
     f.frequency.setValueAtTime(hp, t0);

     const g = ctxA.createGain();
     g.gain.setValueAtTime(0.0001, t0);
     g.gain.exponentialRampToValueAtTime(gain, t0 + 0.004);
     g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

     src.connect(f);
     f.connect(g);
     g.connect(out);
     src.start(t0);
     src.stop(t0 + dur + 0.02);
   }

   function sfxThrow(){
     if (!state.enabled) return;
     const t = now();
     noise(t, 0.05, 0.07, 1800, sfxBus);
     tone(950, t, 0.06, "sine", 0.10, sfxBus);
     tone(1550, t + 0.012, 0.05, "sine", 0.07, sfxBus);
   }

   function sfxHit(){
     if (!state.enabled) return;
     const t = now();
     tone(90, t, 0.10, "sine", 0.22, sfxBus);
     tone(2200, t + 0.02, 0.07, "square", 0.10, sfxBus);
     noise(t + 0.018, 0.10, 0.12, 1200, sfxBus);
   }

   function sfxMiss(){
     if (!state.enabled) return;
     const t = now();
     tone(420, t, 0.08, "triangle", 0.07, sfxBus);
     tone(330, t + 0.03, 0.09, "sine", 0.05, sfxBus);
   }

   function sfxCombo(n){
     if (!state.enabled) return;
     const t = now();
     const base = 520 + Math.min(420, n*18);
     tone(base, t, 0.08, "square", 0.09, sfxBus);
     tone(base*1.33, t+0.04, 0.10, "triangle", 0.07, sfxBus);
     noise(t+0.02, 0.06, 0.06, 5200, sfxBus);
   }

   const kickSteps = new Set([0, 4, 8, 12, 14]);
   const snrSteps = new Set([4, 12]);
   const hatSteps = new Set([2, 6, 10, 14]);

   const bassSeq = [523.25, 659.25, 783.99, 987.77, 1046.5, 987.77, 783.99, 659.25];
   const arp = [1046.5, 1318.5, 1567.98, 1318.5];

   function schedule(){
     if (!state.enabled) return;
     const spb = 60 / state.bpm;
     const stepDur = 0.25 * spb;

     while (state.next < now() + 0.12){
       const s = state.step % 16;
       const t = state.next;

       if (kickSteps.has(s)){
         const o = ctxA.createOscillator();
         const g = ctxA.createGain();
         o.type = "sine";
         o.frequency.setValueAtTime(150, t);
         o.frequency.exponentialRampToValueAtTime(46, t + 0.11);
         g.gain.setValueAtTime(0.0001, t);
         g.gain.exponentialRampToValueAtTime(0.26, t + 0.005);
         g.gain.exponentialRampToValueAtTime(0.0001, t + 0.16);
         o.connect(g);
         g.connect(musicBus);
         o.start(t);
         o.stop(t + 0.18);
       }

       if (snrSteps.has(s)){
         noise(t, 0.06, 0.10, 2000, musicBus);
         tone(190, t, 0.05, "triangle", 0.07, musicBus);
       }

       if (hatSteps.has(s)){
         noise(t, 0.03, 0.05, 7000, musicBus);
       }

       if (s % 2 === 0){
         const f = bassSeq[(s/2) % bassSeq.length];
         tone(f, t, 0.14, "sawtooth", 0.065, musicBus);
       }

       if ([1, 5, 9, 13].includes(s)){
         const f = arp[(s/4) | 0];
         tone(f, t, 0.10, "square", 0.05, musicBus);
         tone(f/2, t, 0.10, "triangle", 0.03, musicBus);
       }

       state.step++;
       state.next += stepDur;
     }
   }

   function startMusic(){
     state.next = now();
     state.step = 0;
     if (state.timer) clearInterval(state.timer);
     state.timer = setInterval(schedule, 25);
   }

   function stopMusic(){
     if (state.timer) clearInterval(state.timer);
     state.timer = null;
   }

   audio = {
     state,
     startMusic,
     stopMusic,
     sfxThrow,
     sfxHit,
     sfxMiss,
     sfxCombo,
     async resume(){
       if (ctxA.state === "suspended") {
         try { await ctxA.resume(); } catch(e) {}
       }
     }
   };

   startMusic();
   return audio;
 }

 async function ensureAudio(){
   const a = initAudio();
   await a.resume();
   return a;
 }

 function setSoundEnabled(on){
   const a = initAudio();
   a.state.enabled = on;
   soundBtn.textContent = on ? "üîä Son" : "üîá Son";
 }

 // GAME STATE
 let S = null;

 function newState(){
   return {
     running:false,
     paused:false,
     d:"easy",
     score:0,
     hits:0,
     combo:0,
     timeLeft:30,
     targets:[],
     projectiles:[],
     particles:[],
     spawnT:0,
     lastT:0,
     timerId:null,
     pointer: { x: window.innerWidth/2, y: window.innerHeight/2, has:false },
   };
 }

 function reset(){
   S = newState();
   updateHud();
 }

 function updateHud(){
   scoreEl.textContent = S.score;
   timeEl.textContent = S.timeLeft;
   hitsEl.textContent = S.hits;
 }

 // TARGETS
 function spawnTarget(){
   const f = friends[(Math.random()*friends.length)|0];
   const size = 148;

   const x = rand(20, window.innerWidth - size - 20);
   const y = rand(90, window.innerHeight - size - 140);

   const sp = diff[S.d].speed;
   const vx = rand(-1, 1) * sp;
   const vy = rand(-1, 1) * sp;

   const img = imageCache.get(f.id);
   if (!img || !img.complete) {
     console.warn(`Image for ${f.id} not ready, using fallback`);
   }

   S.targets.push({
     f,
     x,
     y,
     vx,
     vy,
     size,
     img,
     wob: rand(0, Math.PI*2),
   });
 }

 function updateTargets(dt){
   for (const t of S.targets){
     t.wob += dt * 4.2;
     const wobble = Math.sin(t.wob) * 0.35;

     t.x += (t.vx + wobble) * dt * 60;
     t.y += (t.vy - wobble) * dt * 60;

     if (t.x < 12){ t.x = 12; t.vx = Math.abs(t.vx); }
     if (t.x > window.innerWidth - t.size - 12){ t.x = window.innerWidth - t.size - 12; t.vx = -Math.abs(t.vx); }
     if (t.y < 80){ t.y = 80; t.vy = Math.abs(t.vy); }
     if (t.y > window.innerHeight - t.size - 120){ t.y = window.innerHeight - t.size - 120; t.vy = -Math.abs(t.vy); }
   }
 }

 function drawTargets(){
   for (const t of S.targets){
     const cx = t.x + t.size/2;
     const cy = t.y + t.size/2;
     const r = t.size/2;

     ctx.save();
     ctx.shadowColor = "rgba(255,105,180,.35)";
     ctx.shadowBlur = 22;

     ctx.beginPath();
     ctx.arc(cx, cy, r + 6, 0, Math.PI*2);
     ctx.fillStyle = "rgba(255,255,255,.10)";
     ctx.fill();

     ctx.beginPath();
     ctx.arc(cx, cy, r, 0, Math.PI*2);
     ctx.closePath();
     ctx.save();
     ctx.clip();

     if (t.img.complete && (t.img.naturalWidth || t.img.width)){
       drawImageCover(ctx, t.img, t.x, t.y, t.size, t.size);
     } else {
       ctx.fillStyle = "rgba(255,255,255,.12)";
       ctx.fillRect(t.x, t.y, t.size, t.size);
     }

     ctx.restore();

     ctx.strokeStyle = "rgba(255,105,180,.68)";
     ctx.lineWidth = 4;
     ctx.beginPath();
     ctx.arc(cx, cy, r, 0, Math.PI*2);
     ctx.stroke();

     ctx.shadowColor = "transparent";
     ctx.fillStyle = "rgba(0,0,0,.55)";
     const tagW = ctx.measureText(t.f.name).width + 22;
     const tagX = cx - tagW/2;
     const tagY = t.y + t.size + 8;
     roundRect(ctx, tagX, tagY, tagW, 22, 10);
     ctx.fill();
     ctx.fillStyle = "rgba(75,0,75,.92)";
     ctx.font = "700 13px Oxanium";
     ctx.textAlign = "center";
     ctx.textBaseline = "middle";
     ctx.fillText(t.f.name, cx, tagY + 11);

     ctx.restore();
   }
 }

 function roundRect(ctx,x,y,w,h,r){
   const rr = Math.min(r, w/2, h/2);
   ctx.beginPath();
   ctx.moveTo(x+rr, y);
   ctx.arcTo(x+w, y, x+w, y+h, rr);
   ctx.arcTo(x+w, y+h, x, y+h, rr);
   ctx.arcTo(x, y+h, x, y, rr);
   ctx.arcTo(x, y, x+w, y, rr);
   ctx.closePath();
 }

 // PROJECTILES (LANCER DE THERMOM√àTRE)
 function throwThermometer(tx, ty){
   const fromX = window.innerWidth / 2;
   const fromY = window.innerHeight - 84;

   let ax = tx, ay = ty;
   let best = null;
   let bestD = 1e9;
   for (const t of S.targets){
     const cx = t.x + t.size/2;
     const cy = t.y + t.size/2;
     const d = Math.hypot(ax - cx, ay - cy);
     if (d < bestD){ bestD = d; best = {cx, cy}; }
   }
   if (best && bestD <= AIM_ASSIST_RADIUS){
     ax = best.cx;
     ay = best.cy;
   }

   const dx = ax - fromX;
   const dy = ay - fromY;
   const dist = Math.max(1, Math.hypot(dx, dy));

   const baseSpeed = 1550;
   const dur = clamp(dist / baseSpeed, 0.18, 0.62);

   const vx = dx / dur;
   const vy = (dy - 0.5 * GRAVITY * dur * dur) / dur;

   S.projectiles.push({
     x: fromX,
     y: fromY,
     vx,
     vy,
     life: dur + 0.35,
     rot: rand(0, Math.PI*2),
     rvel: rand(-12, 12),
     sparkle: 1.0,
   });

   for (let i=0;i<10;i++){
     S.particles.push({
       x: fromX,
       y: fromY,
       vx: rand(-220,220),
       vy: rand(-380,-120),
       life: rand(0.12, 0.22),
       size: rand(2,4),
       col: `rgba(255,105,180,${rand(0.25,0.75)})`,
     });
   }
 }

 function updateProjectiles(dt){
   for (let i=S.projectiles.length-1;i>=0;i--){
     const p = S.projectiles[i];

     p.vy += GRAVITY * dt;
     p.x += p.vx * dt;
     p.y += p.vy * dt;
     p.rot += p.rvel * dt;
     p.life -= dt;

     const tN = (S.d === "insane") ? 3 : 2;
     for (let k=0;k<tN;k++){
       if (Math.random() < 0.95){
         const thermometer = Math.random() < 0.35;
         S.particles.push({
           x: p.x + rand(-6,6),
           y: p.y + rand(-6,6),
           vx: rand(-60,60),
           vy: rand(-60,60),
           life: rand(0.12, 0.22),
           size: rand(2,4),
           col: thermometer
             ? `rgba(255,105,180,${rand(0.25,0.65)})`
             : `rgba(255,182,193,${rand(0.25,0.75)})`,
         });
       }
     }

     if (p.life <= 0 || p.x < -120 || p.x > window.innerWidth+120 || p.y < -140 || p.y > window.innerHeight+140){
       S.projectiles.splice(i,1);
       if (Math.random() < 0.45){
         audio?.sfxMiss?.();
         showHitBubble(pick(missMessages), clamp(p.x, 60, window.innerWidth-60), clamp(p.y, 80, window.innerHeight-120), "Miss");
       }
     }
   }
 }

 function drawProjectiles(){
   ctx.save();
   ctx.font = "44px system-ui";
   ctx.textAlign = "center";
   ctx.textBaseline = "middle";
   for (const p of S.projectiles){
     ctx.save();
     ctx.translate(p.x, p.y);
     ctx.rotate(p.rot);
     ctx.shadowColor = "rgba(255,105,180,.35)";
     ctx.shadowBlur = 22;
     ctx.fillText("üå°Ô∏è", 0, 0);
     ctx.restore();
   }
   ctx.restore();
 }

 // PARTICLES (identique)
 function burst(x,y){
   for (let i=0;i<18;i++){
     S.particles.push({
       x, y,
       vx: rand(-260,260),
       vy: rand(-320,200),
       life: rand(0.25, 0.45),
       size: rand(2,5),
       col: `rgba(255,105,180,${rand(0.25,0.8)})`,
     });
   }
   for (let i=0;i<10;i++){
     S.particles.push({
       x, y,
       vx: rand(-220,220),
       vy: rand(-220,220),
       life: rand(0.2, 0.35),
       size: rand(3,6),
       col: `rgba(255,182,193,${rand(0.2,0.7)})`,
     });
   }
 }

 function updateParticles(dt){
   for (let i=S.particles.length-1;i>=0;i--){
     const p = S.particles[i];
     p.x += p.vx * dt;
     p.y += p.vy * dt;
     p.vx *= Math.pow(0.08, dt);
     p.vy += 520 * dt;
     p.life -= dt;
     if (p.life <= 0) S.particles.splice(i,1);
   }
 }

 function drawParticles(){
   for (const p of S.particles){
     if (p.vx === 0 && p.vy === 0 && p.col === "rgba(255,255,255,.0)"){
       const t = clamp(p.life / 0.22, 0, 1);
       const rr = 18 + (1 - t) * 34;
       ctx.save();
       ctx.globalAlpha = t;
       ctx.strokeStyle = "rgba(255,105,180,.55)";
       ctx.lineWidth = 3;
       ctx.beginPath();
       ctx.arc(p.x, p.y, rr, 0, Math.PI*2);
       ctx.stroke();
       ctx.strokeStyle = "rgba(255,182,193,.35)";
       ctx.lineWidth = 6;
       ctx.beginPath();
       ctx.arc(p.x, p.y, rr + 6, 0, Math.PI*2);
       ctx.stroke();
       ctx.restore();
       continue;
     }

     ctx.fillStyle = p.col;
     ctx.beginPath();
     ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
     ctx.fill();
   }
 }

 // COLLISIONS (identique)
 function collide(){
   for (let pi=S.projectiles.length-1; pi>=0; pi--){
     const p = S.projectiles[pi];
     for (let ti=S.targets.length-1; ti>=0; ti--){
       const t = S.targets[ti];
       const cx = t.x + t.size/2;
       const cy = t.y + t.size/2;
       const r = t.size/2;
       const d = Math.hypot(p.x - cx, p.y - cy);
       if (d < r - 6){
         S.projectiles.splice(pi,1);
         S.targets.splice(ti,1);

         S.hits++;
         S.combo++;
         S.score += diff[S.d].points + Math.min(40, (S.combo-1) * 2);
         updateHud();

         audio?.sfxHit?.();
         burst(cx, cy);
         gameEl.classList.remove("shake");
         void gameEl.offsetWidth;
         gameEl.classList.add("shake");

         S.particles.push({ x: cx, y: cy, vx: 0, vy: 0, life: 0.22, size: 2, col: "rgba(255,255,255,.0)" });

         const finger = document.createElement("div");
         finger.className = "middleFinger";
         finger.textContent = "üñï";
         finger.style.left = cx + "px";
         finger.style.top = cy + "px";
         finger.style.setProperty("--r", (rand(-22, 22)).toFixed(1) + "deg");
         gameEl.appendChild(finger);
         setTimeout(() => finger.remove(), 1200);

         const msg = pick(hitMessagesByCharacter[t.f.id] || ["Touch√© !"]);
         showHitBubble(msg, cx + r + 8, cy, t.f.name);

         if (S.combo === 3 || S.combo === 5 || (S.combo > 5 && S.combo % 5 === 0)){
           showCombo(S.combo);
           audio?.sfxCombo?.(S.combo);
         }

         break;
       }
     }
   }
 }

 // LOOP (identique)
 function drawAim(){
   if (!S.pointer.has) return;
   ctx.save();
   ctx.strokeStyle = "rgba(255,105,180,.55)";
   ctx.lineWidth = 2;
   const cx = S.pointer.x;
   const cy = S.pointer.y;
   const r = 18;
   ctx.beginPath();
   ctx.arc(cx, cy, r, 0, Math.PI*2);
   ctx.stroke();
   ctx.beginPath();
   ctx.moveTo(cx - r - 8, cy);
   ctx.lineTo(cx - r - 2, cy);
   ctx.moveTo(cx + r + 2, cy);
   ctx.lineTo(cx + r + 8, cy);
   ctx.moveTo(cx, cy - r - 8);
   ctx.lineTo(cx, cy - r - 2);
   ctx.moveTo(cx, cy + r + 2);
   ctx.lineTo(cx, cy + r + 8);
   ctx.stroke();
   ctx.restore();
 }

 function loop(ts){
   if (!S.running) return;
   if (!S.lastT) S.lastT = ts;
   const dt = clamp((ts - S.lastT) / 1000, 0, 0.033);
   S.lastT = ts;

   if (!S.paused){
     S.spawnT += dt * 1000;
     if (S.spawnT >= diff[S.d].spawnMs){
       S.spawnT = 0;
       spawnTarget();
     }

     updateTargets(dt);
     updateProjectiles(dt);
     updateParticles(dt);
     collide();
   }

   ctx.clearRect(0,0,window.innerWidth, window.innerHeight);

   const vg = ctx.createRadialGradient(window.innerWidth*0.5, window.innerHeight*0.45, 120, window.innerWidth*0.5, window.innerHeight*0.5, Math.max(window.innerWidth, window.innerHeight));
   vg.addColorStop(0, "rgba(255,255,255,.03)");
   vg.addColorStop(1, "rgba(75,0,75,.28)");
   ctx.fillStyle = vg;
   ctx.fillRect(0,0,window.innerWidth, window.innerHeight);

   drawParticles();
   drawTargets();
   drawProjectiles();
   drawAim();

   requestAnimationFrame(loop);
 }

 // TIMER (identique)
 function startTimer(){
   if (S.timerId) clearInterval(S.timerId);
   S.timerId = setInterval(() => {
     if (!S.running || S.paused) return;
     S.timeLeft--;
     updateHud();
     if (S.timeLeft <= 0) endGame();
   }, 1000);
 }

 // START / END (identique)
 async function startGame(which){
   reset();
   S.d = which;
   S.timeLeft = diff[which].duration;

   await ensureAudio();
   initAudio().startMusic();

   startEl.style.display = "none";
   endEl.style.display = "none";
   canvas.style.display = "block";
   hudEl.style.display = "flex";
   topRightEl.style.display = "flex";

   S.running = true;
   S.paused = false;
   pauseBtn.textContent = "‚è∏ Pause";

   for (let i=0;i<4;i++) spawnTarget();

   startTimer();
   requestAnimationFrame(loop);
 }

 function endGame(){
   S.running = false;
   if (S.timerId) clearInterval(S.timerId);

   initAudio().stopMusic();

   canvas.style.display = "none";
   hudEl.style.display = "none";
   topRightEl.style.display = "none";

   finalScoreEl.textContent = S.score;
   let msg = finalMessages[0].msg;
   for (const m of finalMessages){
     if (S.score >= m.min && S.score <= m.max){ msg = m.msg; break; }
   }
   finalMsgEl.textContent = msg;
   endEl.style.display = "flex";
 }

 function restart(){
   endEl.style.display = "none";
   startEl.style.display = "flex";
 }

 function togglePause(){
   if (!S.running) return;
   S.paused = !S.paused;
   pauseBtn.textContent = S.paused ? "‚ñ∂ Reprendre" : "‚è∏ Pause";
 }

 // INPUTS (identique)
 canvas.addEventListener("pointermove", (e) => {
   if (!S) return;
   const rect = canvas.getBoundingClientRect();
   S.pointer.x = e.clientX - rect.left;
   S.pointer.y = e.clientY - rect.top;
   S.pointer.has = true;
 });

 canvas.addEventListener("pointerleave", () => {
   if (!S) return;
   S.pointer.has = false;
 });

 canvas.addEventListener("click", async (e) => {
   if (!S.running || S.paused) return;
   await ensureAudio();
   initAudio().sfxThrow();

   const rect = canvas.getBoundingClientRect();
   const x = e.clientX - rect.left;
   const y = e.clientY - rect.top;
   throwThermometer(x, y);
 });

 const enterBtn = document.getElementById("enterBtn");
 const enterSection = document.getElementById("enterSection");
 const diffSection = document.getElementById("diffSection");

 if (enterBtn && enterSection && diffSection){
   enterBtn.addEventListener("click", async () => {
     try { await ensureAudio(); } catch(e) { console.warn("Audio warmup failed", e); }

     enterSection.style.display = "none";
     diffSection.style.display = "block";
   });
 }

 document.querySelectorAll(".diff").forEach(btn => {
   btn.addEventListener("click", () => startGame(btn.dataset.diff));
 });

 restartBtn.addEventListener("click", restart);
 pauseBtn.addEventListener("click", togglePause);

 soundBtn.addEventListener("click", async () => {
   await ensureAudio();
   const a = initAudio();
   setSoundEnabled(!a.state.enabled);
 });

 window.addEventListener("keydown", (e) => {
   const k = e.key.toLowerCase();
   if (k === "p") togglePause();
   if (k === "r"){
     if (S.running) endGame();
     restart();
   }
 });

 preloadImages();
 reset();
 resize();
 setSoundEnabled(true);
 </script>
</body>
</html>
